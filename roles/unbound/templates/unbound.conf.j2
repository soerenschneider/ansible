server:
{% for network in networks[location].devices | default({}) %}
{% if network.dns is defined and network.dns %}
    interface: {{ network.address | ipaddr('address') }}
{% endif %}
{% endfor %}
    interface: 127.0.0.1
    access-control: 0.0.0.0/0 refuse
    access-control: 127.0.0.1 allow

{% if unbound_listen_ipv6 %}
    interface: ::1
    access-control: ::0/0 refuse
    access-control: ::1 allow
{% endif %}

{% for network in networks[location].devices  | default({}) %}
{% if network.dns is defined and network.dns %}
    access-control: {{ network.address | ipaddr(0) }} allow
{% endif %}
{% endfor %}
{% for source in unbound_additional_allowed_sources %}
    access-control: {{ source }} allow
{% endfor %}

    hide-identity: yes
    hide-version: yes
    use-caps-for-id: yes
    aggressive-nsec: yes
    qname-minimisation: yes
    rrset-roundrobin: {% if unbound_enable_roundrobin | default(False) %}yes{% else %}no{% endif %}

{% if unbound_forward_tls_upstream %}
{% if ansible_os_family == "RedHat" %}
    tls-cert-bundle: /etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem
{% else %}
    tls-cert-bundle: /etc/ssl/certs/ca-certificates.crt
{% endif %}
{% endif %}

    # performance
    outgoing-range: 4096
    num-queries-per-thread: 2048
    so-reuseport: yes
    num-threads: 2
    rrset-cache-size: 100m
    msg-cache-size: 50m
    msg-cache-slabs: 1
    rrset-cache-slabs: 1
    infra-cache-slabs: 1
    key-cache-slabs: 1

{% if unbound_exporter_enabled %}
    extended-statistics: yes
    statistics-cumulative: no
{% endif %}

    # TODO: maybe look at this to enhance security
    chroot: ""

{% if ansible_os_family | lower != 'redhat' %}
    auto-trust-anchor-file: "{{ unbound_root_key_file }}"
{% endif %}
    val-log-level: 2

{% for network_domain in network_domains %}
    local-zone: "{{ location }}.{{ network_domain }}." transparent
    domain-insecure: {{ network_domain }}
{% endfor %}

{% for wildcard_domain in unbound_wildcard_domains %}
    local-zone: "{{ wildcard_domain.domain }}" redirect
    local-data: "{{ wildcard_domain.domain }} 3600 IN A {{ wildcard_domain.record_a }}"
{% endfor %}

include: {{ unbound_config_dir }}/{% if ansible_os_family | lower == 'debian' %}unbound.{% endif %}conf.d/*.db

# forward requests
{% if unbound_nameservers is defined and unbound_nameservers | length > 0 %}
forward-zone:
    name: "."
    forward-tls-upstream: {% if unbound_forward_tls_upstream %}yes{% else %}no{% endif %}

    {% for nameserver in unbound_nameservers %}
    forward-addr: {{ nameserver }}
    {% endfor %}
{% endif %}

{% if unbound_exporter_enabled %}
remote-control:
    control-enable: yes
    control-interface: {{ unbound_remote_control_socket_path }}
{% endif %}
