---
- name: Collect pubs keys for authorized_keys file
  ansible.builtin.set_fact:
    baseline_soft_keys: |
      {% set result = [] %}
      {% for k in baseline_authorized_keys_soft %}
      {%   set _ = result.append({
            'pub': k.pub,
            'key_options': (k.opts | default('') + ',' + (k.from | default(baseline_ssh_authorized_keys_soft_from_default))) if baseline_ssh_authorized_keys_soft_confine else (k.opts | default(''))
          }) %}
      {% endfor %}
      {{ result }}
  tags: [base, authorized_keys, ssh]

- name: Add current user to authorized_keys_users
  ansible.builtin.set_fact:
    baseline_authorized_keys_users: "{{ authorized_keys_users | default([]) + ([ansible_user] if ansible_user is defined else []) | unique }}"
  tags: [base, authorized_keys, ssh]

- name: Build complete authorized keys list
  set_fact:
    baseline_ssh_authorized_keys: |
      {% for pubkey in baseline_authorized_keys_hw %}
      {{ pubkey.key_options | default('') }} {{ pubkey.pub }}
      {% endfor %}
      {% for soft_key in baseline_soft_keys %}
      {{ soft_key.key_options | default('') }} {{ soft_key.pub }}
      {% endfor %}
  tags: [base, authorized_keys, ssh]

- name: Manage all SSH authorized keys exclusively
  ansible.posix.authorized_key:
    user: "{{ item }}"
    key: "{{ baseline_ssh_authorized_keys }}"
    exclusive: true
    state: present
  loop: "{{ baseline_authorized_keys_users }}"
  tags: [base, authorized_keys, ssh]



- name: Add custom ssh keys
  ansible.posix.authorized_key:
    key: "{{ item.pub }}"
    exclusive: false
    key_options: "{{ item.options | default(omit) }}"
    user: "{{ item.user }}"
  when: item.pub is defined and item.user is defined
  with_items: "{{ additional_authorized_keys }}"
  tags: [base, authorized_keys, ssh]
