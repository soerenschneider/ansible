---
- name: Get kubeconfig from k0s
  ansible.builtin.command: k0s kubeconfig admin
  register: k0s_kubeconfig_raw
  tags: [k0s, kubeconf]

- name: Parse cluster data
  ansible.builtin.set_fact:
    k0s_cluster_info:
      name: '{{ k0s_cluster_name if k0s_cluster_name != "" else inventory_hostname }}'
      ca_data: "{{ (k0s_kubeconfig_raw.stdout | from_yaml).clusters[0].cluster['certificate-authority-data'] }}"
      server: "{{ (k0s_kubeconfig_raw.stdout | from_yaml).clusters[0].cluster.server }}"
  tags: [k0s, kubeconf]

- name: Store cluster info centrally
  ansible.builtin.set_fact:
    k0s_all_clusters: "{{ k0s_all_clusters | default([]) + [k0s_cluster_info] }}"
  run_once: true
  delegate_to: localhost
  tags: [k0s, kubeconf]

- name: Write CA cert files
  ansible.builtin.copy:
    content: "{{ item.ca_data | b64decode }}"
    dest: "/tmp/{{ item.name }}-ca.crt"
    owner: "root"
    group: "root"
    mode: "0644"
  loop: "{{ k0s_all_clusters }}"
  loop_control:
    label: "{{ item.name }}"
  run_once: true
  delegate_to: localhost
  become: false
  tags: [k0s, kubeconf]

- name: Set cluster in kubeconfig
  ansible.builtin.command: >
    kubectl config set-cluster {{ item.name }}
    --server={{ item.server }}
    --certificate-authority=/tmp/{{ item.name }}-ca.crt
    --embed-certs=true
  loop: "{{ k0s_all_clusters }}"
  loop_control:
    label: "{{ item.name }}"
  become: false
  run_once: true
  delegate_to: localhost
  tags: [k0s, kubeconf]

- name: Set user with OIDC
  ansible.builtin.command: >
    kubectl config set-credentials {{ item.name }}-oidc
    --exec-api-version=client.authentication.k8s.io/v1
    --exec-command=kubectl
    --exec-arg=oidc-login
    --exec-arg=get-token
    --exec-arg=--oidc-issuer-url={{ k0s_oidc_issuer_url }}
    --exec-arg=--oidc-client-id={{ k0s_oidc_client_id }}
    --exec-interactive-mode=Always
  loop: "{{ k0s_all_clusters }}"
  loop_control:
    label: "{{ item.name }}"
  run_once: true
  delegate_to: localhost
  become: false
  tags: [k0s, kubeconf]

- name: Set context
  ansible.builtin.command: >
    kubectl config set-context {{ item.name }}
    --cluster={{ item.name }}
    --user={{ item.name }}-oidc
  loop: "{{ k0s_all_clusters }}"
  loop_control:
    label: "{{ item.name }}"
  run_once: true
  delegate_to: localhost
  become: false
  tags: [k0s, kubeconf]
